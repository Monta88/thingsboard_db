{
  "ruleChain": {
    "additionalInfo": null,
    "name": "gumpen_aggregate_energy_power",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": null,
    "nodes": [
      {
        "additionalInfo": {
          "layoutX": 948,
          "layoutY": 583
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 933,
          "layoutY": 377
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 72,
          "layoutY": 309
        },
        "type": "org.thingsboard.rule.engine.analytics.latest.telemetry.TbAggLatestTelemetryNode",
        "name": "energy_groups",
        "debugMode": false,
        "configuration": {
          "parentEntitiesQuery": {
            "type": "relationsQuery",
            "rootEntityId": {
              "entityType": "ASSET",
              "id": "143721e0-fbe9-11e9-8139-0930b3399b01"
            },
            "relationsQuery": {
              "direction": "FROM",
              "maxLevel": 1,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "ASSET"
                  ]
                }
              ]
            },
            "childRelationsQuery": {
              "direction": "FROM",
              "maxLevel": 2,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "DEVICE"
                  ]
                }
              ]
            }
          },
          "periodTimeUnit": "MINUTES",
          "periodValue": 1,
          "aggMappings": [
            {
              "source": "tmp_active_power_positive",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_consumption",
              "aggFunction": "SUM"
            },
            {
              "source": "",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_positive_count",
              "aggFunction": "COUNT"
            },
            {
              "source": "tmp_active_energy_export",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_energy_production",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_energy_import",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_energy_consumption",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_power_negative",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_production",
              "aggFunction": "SUM"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "layoutX": 68,
          "layoutY": 460
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Documentation",
        "debugMode": false,
        "configuration": {
          "jsScript": "/*\n\nOn all Main meters:\n\nSum  tmp_active_power_positive -> tmp_active_power_consumption\nSum  tmp_active_power_negative -> tmp_active_power_production\n\n*/\n\nreturn false;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 917,
          "layoutY": 860
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Move up",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "ASSET"
                ]
              }
            ],
            "fetchLastLevelOnly": false
          }
        }
      },
      {
        "additionalInfo": {
          "layoutX": 675,
          "layoutY": 862
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Move up",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "ASSET"
                ]
              }
            ],
            "fetchLastLevelOnly": false
          }
        }
      },
      {
        "additionalInfo": {
          "layoutX": 68,
          "layoutY": 257
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Documentation",
        "debugMode": false,
        "configuration": {
          "jsScript": "/*\n\nFind all assets [x] related from iot1911_energy_groups\n\nFind all attributes [y] (listed below) from [x] and sum them\n\nSum  tmp_active_power_positive -> tmp_active_power_consumption\nSum  tmp_active_power_negative -> tmp_active_power_production\nSum energy export\nSum energy import\n\n*/\n\nreturn false;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 395,
          "layoutY": 1010
        },
        "type": "org.thingsboard.rule.engine.analytics.incoming.TbSimpleAggMsgNode",
        "name": "agg",
        "debugMode": false,
        "configuration": {
          "parentEntitiesQuery": {
            "type": "group",
            "entityGroupId": null
          },
          "periodTimeUnit": "MINUTES",
          "periodValue": 5,
          "mathFunction": "SUM",
          "aggIntervalTimeUnit": "SECONDS",
          "aggIntervalValue": 15,
          "autoCreateIntervals": false,
          "intervalPersistencePolicy": "ON_EACH_CHECK_AFTER_INTERVAL_END",
          "intervalCheckTimeUnit": "SECONDS",
          "intervalCheckValue": 15,
          "intervalTtlTimeUnit": "DAYS",
          "intervalTtlValue": 1,
          "inputValueKey": "active_power_positive",
          "outputValueKey": "_sum_",
          "statePersistencePolicy": "ON_EACH_CHANGE",
          "statePersistenceTimeUnit": "MINUTES",
          "statePersistenceValue": 1
        }
      },
      {
        "additionalInfo": {
          "layoutX": 383,
          "layoutY": 854
        },
        "type": "org.thingsboard.rule.engine.filter.TbCheckMessageNode",
        "name": "check field",
        "debugMode": false,
        "configuration": {
          "messageNames": [
            "active_power_positive"
          ],
          "metadataNames": [],
          "checkAllKeys": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 675,
          "layoutY": 1020
        },
        "type": "org.thingsboard.rule.engine.filter.TbCheckMessageNode",
        "name": "check filed",
        "debugMode": false,
        "configuration": {
          "messageNames": [
            "_sum_"
          ],
          "metadataNames": [],
          "checkAllKeys": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 942,
          "layoutY": 1022
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "telemetry to attribute",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Convert all messages to POST_ATTRIBUTES_REQUEST\n\nmsgType_tmp = \"POST_ATTRIBUTES_REQUEST\";\nreturn {msg: msg, metadata: metadata, msgType: msgType_tmp};\n\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 65,
          "layoutY": 674
        },
        "type": "org.thingsboard.rule.engine.analytics.latest.telemetry.TbAggLatestTelemetryNode",
        "name": "building",
        "debugMode": false,
        "configuration": {
          "parentEntitiesQuery": {
            "type": "relationsQuery",
            "rootEntityId": {
              "entityType": "ASSET",
              "id": "39efd180-ca60-11e9-adb0-999291330ae2"
            },
            "relationsQuery": {
              "direction": "FROM",
              "maxLevel": 1,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "ASSET"
                  ]
                }
              ]
            },
            "childRelationsQuery": {
              "direction": "FROM",
              "maxLevel": 1,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "ASSET"
                  ]
                }
              ]
            }
          },
          "periodTimeUnit": "MINUTES",
          "periodValue": 1,
          "aggMappings": [
            {
              "source": "tmp_active_power_positive",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_positive",
              "aggFunction": "SUM"
            },
            {
              "source": "",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_consumption_count",
              "aggFunction": "COUNT"
            },
            {
              "source": "tmp_active_power_negative",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_negative",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_energy_import",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_energy_import",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_energy_export",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_energy_export",
              "aggFunction": "SUM"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "layoutX": 61,
          "layoutY": 517
        },
        "type": "org.thingsboard.rule.engine.analytics.latest.telemetry.TbAggLatestTelemetryNode",
        "name": "energy_meter_main",
        "debugMode": false,
        "configuration": {
          "parentEntitiesQuery": {
            "type": "relationsQuery",
            "rootEntityId": {
              "entityType": "ASSET",
              "id": "e4b3a660-fc9b-11e9-a477-03be7e97a7d9"
            },
            "relationsQuery": {
              "direction": "FROM",
              "maxLevel": 1,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "ASSET"
                  ]
                }
              ]
            },
            "childRelationsQuery": {
              "direction": "FROM",
              "maxLevel": 2,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "DEVICE"
                  ]
                }
              ]
            }
          },
          "periodTimeUnit": "MINUTES",
          "periodValue": 1,
          "aggMappings": [
            {
              "source": "tmp_active_power_positive",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_consumption",
              "aggFunction": "SUM"
            },
            {
              "source": "",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_consumption_count",
              "aggFunction": "COUNT"
            },
            {
              "source": "tmp_active_power_negative",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_power_production",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_energy_export",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_energy_production",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_energy_import",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "tmp_active_energy_consumption",
              "aggFunction": "SUM"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "layoutX": 478,
          "layoutY": 518
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "telemetry to attribute",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Convert all messages to POST_ATTRIBUTES_REQUEST\n\nmsgType_tmp = \"POST_ATTRIBUTES_REQUEST\";\nreturn {msg: msg, metadata: metadata, msgType: msgType_tmp};\n\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 939,
          "layoutY": 516
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 490,
          "layoutY": 315
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "telemetry to attribute",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Convert all messages to POST_ATTRIBUTES_REQUEST\n\nmsgType_tmp = \"POST_ATTRIBUTES_REQUEST\";\nreturn {msg: msg, metadata: metadata, msgType: msgType_tmp};\n\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 940,
          "layoutY": 319
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 483,
          "layoutY": 682
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "telemetry to attribute",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Convert all messages to POST_ATTRIBUTES_REQUEST\n\nmsgType_tmp = \"POST_ATTRIBUTES_REQUEST\";\nreturn {msg: msg, metadata: metadata, msgType: msgType_tmp};\n\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 944,
          "layoutY": 680
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1192,
          "layoutY": 1018
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 76,
          "layoutY": 362
        },
        "type": "org.thingsboard.rule.engine.analytics.latest.telemetry.TbAggLatestTelemetryNode",
        "name": "energy_groups",
        "debugMode": false,
        "configuration": {
          "parentEntitiesQuery": {
            "type": "relationsQuery",
            "rootEntityId": {
              "entityType": "ASSET",
              "id": "143721e0-fbe9-11e9-8139-0930b3399b01"
            },
            "relationsQuery": {
              "direction": "FROM",
              "maxLevel": 1,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "ASSET"
                  ]
                }
              ]
            },
            "childRelationsQuery": {
              "direction": "FROM",
              "maxLevel": 2,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "DEVICE"
                  ]
                }
              ]
            }
          },
          "periodTimeUnit": "MINUTES",
          "periodValue": 1,
          "aggMappings": [
            {
              "source": "tmp_active_power_positive",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "ts_active_power_consumption",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_energy_import",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "ts_active_energy_consumption",
              "aggFunction": "SUM"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "layoutX": 56,
          "layoutY": 583
        },
        "type": "org.thingsboard.rule.engine.analytics.latest.telemetry.TbAggLatestTelemetryNode",
        "name": "energy_meter_main",
        "debugMode": false,
        "configuration": {
          "parentEntitiesQuery": {
            "type": "relationsQuery",
            "rootEntityId": {
              "entityType": "ASSET",
              "id": "e4b3a660-fc9b-11e9-a477-03be7e97a7d9"
            },
            "relationsQuery": {
              "direction": "FROM",
              "maxLevel": 1,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "ASSET"
                  ]
                }
              ]
            },
            "childRelationsQuery": {
              "direction": "FROM",
              "maxLevel": 2,
              "filters": [
                {
                  "relationType": "Contains",
                  "entityTypes": [
                    "DEVICE"
                  ]
                }
              ]
            }
          },
          "periodTimeUnit": "MINUTES",
          "periodValue": 1,
          "aggMappings": [
            {
              "source": "tmp_active_power_positive",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "ts_active_power_consumption",
              "aggFunction": "SUM"
            },
            {
              "source": "tmp_active_energy_import",
              "sourceScope": "SERVER_SCOPE",
              "defaultValue": 0,
              "target": "ts_active_energy_consumption",
              "aggFunction": "SUM"
            }
          ]
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 2,
        "toIndex": 15,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 5,
        "type": "True"
      },
      {
        "fromIndex": 9,
        "toIndex": 10,
        "type": "True"
      },
      {
        "fromIndex": 10,
        "toIndex": 19,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 17,
        "type": "Success"
      },
      {
        "fromIndex": 12,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 13,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 15,
        "toIndex": 16,
        "type": "Success"
      },
      {
        "fromIndex": 17,
        "toIndex": 18,
        "type": "Success"
      },
      {
        "fromIndex": 20,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 21,
        "toIndex": 0,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}