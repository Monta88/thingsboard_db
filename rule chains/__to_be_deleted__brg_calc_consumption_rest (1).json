{
  "ruleChain": {
    "additionalInfo": null,
    "name": "__to_be_deleted__brg_calc_consumption_rest",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": null,
    "nodes": [
      {
        "additionalInfo": {
          "layoutX": 1199,
          "layoutY": 549
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "active_power_x_rest calculation",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Convert message and store it as tmp to POST_ATTRIBUTES_REQUEST\n// Calculate the \"rest\" power from total_power and - consumed_power\n// Calculate the \"rest\" energy from total_energy and - consumed_energy\n\nvar msg_tmp = {};\nmsg_tmp.tmp_active_power_consumption_rest = msg.active_power_positive - metadata.ss_tmp_active_power_consumption;\nmsg_tmp.tmp_active_power_production_rest = msg.active_power_negative - metadata.ss_tmp_active_power_production;\nif (msg.active_energy_import !== undefined) msg_tmp.tmp_active_energy_consumption_rest = msg.active_energy_import - metadata.ss_tmp_active_energy_consumption;\nif (msg.active_energy_export !== undefined) msg_tmp.tmp_active_energy_production_rest = msg.active_energy_export - metadata.ss_tmp_active_energy_production;\n\nmsgType_tmp = \"POST_ATTRIBUTES_REQUEST\";\n\nreturn {msg: msg_tmp, metadata: metadata, msgType: msgType_tmp};"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1525,
          "layoutY": 447
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 359,
          "layoutY": 982
        },
        "type": "org.thingsboard.rule.engine.mail.TbMsgToEmailNode",
        "name": "mail",
        "debugMode": false,
        "configuration": {
          "fromTemplate": "thingsboard@iots.no",
          "toTemplate": "jf@iotsolutions.no",
          "ccTemplate": null,
          "bccTemplate": null,
          "subjectTemplate": "Script fail",
          "bodyTemplate": "Node: gumpen_calc_consumption\n\nDevice: ${deviceName} \nDeviceType: ${deviceType}\nTs: ${ts}"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 288,
          "layoutY": 293
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "device type !(Main)",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Exclude all devices of type containing 'Main'\n\nreturn (metadata.deviceType).search('Main') === -1;\n\n//=== 'EnergyMeter_Electrical_3P_Main' || metadata.deviceType === 'EnergyMeter_Water_Main';\n\n/*\nreturn metadata.deviceName === 'iot1815_energy_meter_electrical_3p_1' || metadata.deviceName === 'iot1815_energy_meter_water_1';*/\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 40,
          "layoutY": 295
        },
        "type": "org.thingsboard.rule.engine.filter.TbCheckMessageNode",
        "name": "check field",
        "debugMode": false,
        "configuration": {
          "messageNames": [
            "active_power_positive",
            "active_power_negative",
            "active_energy_import",
            "active_energy_export"
          ],
          "metadataNames": [],
          "checkAllKeys": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1464,
          "layoutY": 295
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1192,
          "layoutY": 294
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "active_power_positive to attribute.tmp_active_power_positive",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Convert message and store it as tmp to POST_ATTRIBUTES_REQUEST\n\nvar msg_tmp = {};\n\nif (msg.active_power_positive !== null) msg_tmp.tmp_active_power_positive = msg.active_power_positive;\nif (msg.active_power_negative !== null) msg_tmp.tmp_active_power_negative = msg.active_power_negative;\nif (msg.active_energy_import !== null) msg_tmp.tmp_active_energy_import = msg.active_energy_import;\nif (msg.active_energy_export !== null) msg_tmp.tmp_active_energy_export = msg.active_energy_export;\n\nmsgType_tmp = \"POST_ATTRIBUTES_REQUEST\";\n\nreturn {msg: msg_tmp, metadata: metadata, msgType: msgType_tmp};\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 558,
          "layoutY": 433
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Move up",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "ASSET"
                ]
              }
            ],
            "fetchLastLevelOnly": false
          }
        }
      },
      {
        "additionalInfo": {
          "layoutX": 830,
          "layoutY": 440
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "tmp_active_power_cons/prod",
        "debugMode": false,
        "configuration": {
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [
            "tmp_active_power_consumption",
            "tmp_active_power_production",
            "tmp_active_energy_consumption",
            "tmp_active_energy_production",
            "tmp_active_power_consumption_count"
          ],
          "latestTsKeyNames": [],
          "tellFailureIfAbsent": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1204,
          "layoutY": 443
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "active_power_x_rest calculation",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Calculate the \"rest\" power from total_power and - consumed_power\n// Calculate the \"rest\" energy from total_energy and - consumed_energy\n\nvar msg_ts = {};\n\nmsg_ts.ts_active_power_consumption_rest = msg.active_power_positive - metadata.ss_tmp_active_power_consumption;\nmsg_ts.ts_active_power_production_rest = msg.active_power_negative - metadata.ss_tmp_active_power_production;\nif (msg.active_energy_import !== undefined) msg_ts.ts_active_energy_consumption_rest = msg.active_energy_import - metadata.ss_tmp_active_energy_consumption;\nif (msg.active_energy_export !== undefined) msg_ts.ts_active_energy_production_rest = msg.active_energy_export - metadata.ss_tmp_active_energy_production;\n\nreturn {msg: msg_ts, metadata: metadata, msgType: msgType};"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1554,
          "layoutY": 531
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 59,
          "layoutY": 980
        },
        "type": "org.thingsboard.rule.engine.action.TbCreateAlarmNode",
        "name": "alarm",
        "debugMode": false,
        "configuration": {
          "alarmType": "General Alarm",
          "alarmDetailsBuildJs": "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n}\nreturn details;",
          "severity": "CRITICAL",
          "propagate": false,
          "useMessageAlarmData": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1255,
          "layoutY": 988
        },
        "type": "org.thingsboard.rule.engine.action.TbClearAlarmNode",
        "name": "del_alarm",
        "debugMode": false,
        "configuration": {
          "alarmType": "General Alarm",
          "alarmDetailsBuildJs": "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n}\nreturn details;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 658,
          "layoutY": 985
        },
        "type": "org.thingsboard.rule.engine.mail.TbSendEmailNode",
        "name": "mail",
        "debugMode": false,
        "configuration": {
          "useSystemSmtpSettings": true,
          "smtpHost": "smtp.office365.com",
          "smtpPort": 587,
          "username": "jf@iotsolutions.no",
          "password": "ao98etzz",
          "smtpProtocol": "smtp",
          "timeout": 10000,
          "enableTls": true
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1490,
          "layoutY": 112
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "save",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1491,
          "layoutY": 47
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Documentation",
        "debugMode": false,
        "configuration": {
          "jsScript": "/*\nMove the following values from device up to parent asset (for use in dashboards)\n\nactive_power_positive;\nactive_energy_import;\n\n*/\n\nreturn false;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1460,
          "layoutY": 230
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Documentation",
        "debugMode": false,
        "configuration": {
          "jsScript": "/*\nConvert the following values from telemetry to attribute on device (for use sum/aggregatin calculations)\n\ntmp_active_power_positive = msg.active_power_positive;\ntmp_active_power_negative = msg.active_power_negative;\ntmp_active_energy_import = msg.active_energy_import;\ntmp_active_energy_export = msg.active_energy_export;\n\n*/\n\nreturn false;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1445,
          "layoutY": 392
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Documentation",
        "debugMode": false,
        "configuration": {
          "jsScript": "/*\n\nCalculate differense between total power imported and measured consumption on individual ciurcuits\nStore values as attributes\n\ntmp_active_power_consumption_rest = msg.active_power_positive - metadata.ss_tmp_active_power_consumption;\ntmp_active_power_production_rest = msg.active_power_negative - metadata.ss_tmp_active_power_production;\n\n\n*/\n\nreturn false;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 302,
          "layoutY": 123
        },
        "type": "org.thingsboard.rule.engine.filter.TbOriginatorTypeSwitchNode",
        "name": "Device",
        "debugMode": false,
        "configuration": {
          "version": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 595,
          "layoutY": 121
        },
        "type": "org.thingsboard.rule.engine.filter.TbCheckMessageNode",
        "name": "check fields",
        "debugMode": false,
        "configuration": {
          "messageNames": [
            "active_power_positive",
            "active_energy_import"
          ],
          "metadataNames": [],
          "checkAllKeys": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 841,
          "layoutY": 122
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Move up",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "ASSET"
                ]
              }
            ],
            "fetchLastLevelOnly": false
          }
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1169,
          "layoutY": 125
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Effekt + EnergyConsumption to asset",
        "debugMode": false,
        "configuration": {
          "jsScript": "// Move values up to asset\nvar msg_new = {};\n\nmsg_new.active_power_positive = msg.active_power_positive;\n//msg_new.active_power_negative = msg.active_power_negative;\nmsg_new.active_energy_import = msg.active_energy_import;\n//msg_new.active_energy_export = msg.active_energy_export;\n\n\nreturn {msg: msg_new, metadata: metadata, msgType: msgType};"
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 11,
        "type": "Failure"
      },
      {
        "fromIndex": 0,
        "toIndex": 12,
        "type": "Success"
      },
      {
        "fromIndex": 0,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 3,
        "toIndex": 7,
        "type": "False"
      },
      {
        "fromIndex": 3,
        "toIndex": 6,
        "type": "True"
      },
      {
        "fromIndex": 3,
        "toIndex": 19,
        "type": "True"
      },
      {
        "fromIndex": 3,
        "toIndex": 11,
        "type": "Failure"
      },
      {
        "fromIndex": 3,
        "toIndex": 12,
        "type": "True"
      },
      {
        "fromIndex": 3,
        "toIndex": 12,
        "type": "False"
      },
      {
        "fromIndex": 4,
        "toIndex": 3,
        "type": "True"
      },
      {
        "fromIndex": 6,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 11,
        "type": "Failure"
      },
      {
        "fromIndex": 6,
        "toIndex": 12,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 11,
        "type": "Failure"
      },
      {
        "fromIndex": 9,
        "toIndex": 12,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 2,
        "type": "Created"
      },
      {
        "fromIndex": 18,
        "toIndex": 4,
        "type": "Device"
      },
      {
        "fromIndex": 19,
        "toIndex": 20,
        "type": "True"
      },
      {
        "fromIndex": 20,
        "toIndex": 21,
        "type": "Success"
      },
      {
        "fromIndex": 21,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 21,
        "toIndex": 11,
        "type": "Failure"
      },
      {
        "fromIndex": 21,
        "toIndex": 12,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}