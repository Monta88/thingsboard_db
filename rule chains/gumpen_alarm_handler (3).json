{
  "ruleChain": {
    "additionalInfo": {
      "description": "Create/Clear Alarm & send Email"
    },
    "name": "gumpen_alarm_handler",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": 11,
    "nodes": [
      {
        "additionalInfo": {
          "layoutX": 736,
          "layoutY": 541
        },
        "type": "org.thingsboard.rule.engine.action.TbCreateAlarmNode",
        "name": "Create Alarm",
        "debugMode": false,
        "configuration": {
          "alarmType": "General Alarm B",
          "alarmDetailsBuildJs": "var details = {};\ndetails.alarm= msg.alarm_b;\n\nreturn details;\n\n\n/*\n\nvar details = {};\ndetails.alarm= msg.alarm;\nif (metadata.prevAlarmDetails) {\n    var prevDEtails = JSON.parse(metadata.prevAlarmDetails);\n   // details.count = prevDEtails.count + 1;\n}else\n{\n  //  details.count = 1;\n}\nreturn details;\n*/",
          "severity": "MINOR",
          "propagate": true,
          "useMessageAlarmData": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 742,
          "layoutY": 650
        },
        "type": "org.thingsboard.rule.engine.action.TbClearAlarmNode",
        "name": "Clear Alarm",
        "debugMode": false,
        "configuration": {
          "alarmType": "General Alarm B",
          "alarmDetailsBuildJs": " var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n}\ndetails.ClearedAlarm = msg.alarm_b;\nreturn details;\n/*\nvar details = {alarm: msg.Alarm, count: 1};\n\nif (metadata.prevAlarmDetails) {\n    var prevDetails = JSON.parse(metadata.prevAlarmDetails);\n    if(prevDetails.count) {\n        details.count = prevDetails.count + 1;\n    }\n}\n*/\n//return details;\n\n////////////////////////////////////////\n/*var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n}\n//details.ClearedAlarm = msg.alarm;\nreturn details*/\n\n/*\nvar details = {alarm: msg.alarm, count: 0};\n\nif (metadata.prevAlarmDetails) {\n    var prevDetails = JSON.parse(metadata.prevAlarmDetails);\n    if(prevDetails.count) {\n        details.count = prevDetails.count + 1;\n    }\n}\n\nreturn details;\n\n*/"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 484,
          "layoutY": 478
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Under Threshold",
        "debugMode": false,
        "configuration": {
          "jsScript": "return msg.alarm_b == 1;\n//return msg.temperature1 < -30 || msg.temperature1 > 50;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 553,
          "layoutY": 6
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Documentation",
        "debugMode": false,
        "configuration": {
          "jsScript": "/*\nNote: after creating the alarm we have few steps before sending a notification email to customer and the response center\nStep1: \nCheck-in customer level if those server attributes exist or not:\nemail1, email2, email3, email4. If they don't exist add them and set default value \"set@email.com\"\nStep2:\ncheck the existence of those server attributes at the device level(Navn, address, building_name)\n\n*/"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1042,
          "layoutY": 291
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Add values to metdata",
        "debugMode": false,
        "configuration": {
          "jsScript": "metadata.severity= msg.severity;\nmetadata.createdTime= msg.createdTime;\nmetadata.building_name= msg.building_name;\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1387,
          "layoutY": 0
        },
        "type": "org.thingsboard.rule.engine.mail.TbMsgToEmailNode",
        "name": "Notification - Email",
        "debugMode": false,
        "configuration": {
          "fromTemplate": "no-reply@iots.no",
          "toTemplate": "${TenantEmail}",
          "ccTemplate": "",
          "bccTemplate": null,
          "subjectTemplate": "Alarm - ${ss_building_name} - ${ss_Navn}",
          "bodyTemplate": "Hi,\n\nAn ${severity} alarm trigged by ${ss_Navn}.\n\nDetails: \nDate: ${date}\nBuilding: ${ss_building_name}\nAddress: ${ss_address}\nDevice: ${deviceName}\n\nRegards,\nIOT Solutions - Building Automation"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 855,
          "layoutY": 61
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetTenantAttributeNode",
        "name": "Get tenant email",
        "debugMode": false,
        "configuration": {
          "attrMapping": {
            "email1": "TenantEmail"
          },
          "telemetry": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 474,
          "layoutY": 347
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Documentation",
        "debugMode": false,
        "configuration": {
          "jsScript": "/*\nstep1:We are filtring all the devices who have an attribute with a key name \"alarm\"\nstep2:check if the alarm= 1 => create an alarm\nelse clear the alarm\nStep3: send a notification email to the specific customer responsible of that device.\n*/"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 262,
          "layoutY": 73
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Convert timestamp to a date",
        "debugMode": false,
        "configuration": {
          "jsScript": " \n var value= Math.floor(new Date().getTime()/1000.0);\n//return timeConverter(value)\n\nfunction timeConverter(t){\n  var a = new Date(t * 1000);\n  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];\n  var year = a.getFullYear();\n  var month = months[a.getMonth()];\n  var date = a.getDate();\n  var hour = a.getHours()+2;\n  var min = a.getMinutes();\n  var sec = a.getSeconds();\n  var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;\n  return time;\n}\n\n//metadata.date= timeConverter(metadata.createdTime)\nmetadata.date= timeConverter(value)\n\n\n//metadata.date=Math.floor(new Date().getTime()/1000.0);\n\n/*\nvar myDate = new Date(metadata.createdTime *1000);\nmetadata.date=myDate.toGMTString()+\"<br>\"+myDate.toLocaleString();\n*/\n\n/*\nts = new Date(Number(metadata.createdTime)+3600000)\n//ts = new Date(1581683330862)\nmetadata.date = ts.toTimeString()\n*/\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1670,
          "layoutY": 87
        },
        "type": "org.thingsboard.rule.engine.mail.TbSendEmailNode",
        "name": "Send Email SMTP",
        "debugMode": false,
        "configuration": {
          "useSystemSmtpSettings": true,
          "smtpHost": "smtp.office365.com",
          "smtpPort": 587,
          "username": "mj@iotsolutions.no",
          "password": "Monta_2019_iot",
          "smtpProtocol": "smtp",
          "timeout": 10000,
          "enableTls": true
        }
      },
      {
        "additionalInfo": {
          "layoutX": 747,
          "layoutY": 428
        },
        "type": "org.thingsboard.rule.engine.action.TbClearAlarmNode",
        "name": "Clear Alarm",
        "debugMode": false,
        "configuration": {
          "alarmType": "General Alarm A",
          "alarmDetailsBuildJs": " var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n}\ndetails.ClearedAlarm = msg.alarm_a;\nreturn details;\n/*\nvar details = {alarm: msg.Alarm, count: 1};\n\nif (metadata.prevAlarmDetails) {\n    var prevDetails = JSON.parse(metadata.prevAlarmDetails);\n    if(prevDetails.count) {\n        details.count = prevDetails.count + 1;\n    }\n}\n*/\n//return details;\n\n////////////////////////////////////////\n/*var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n}\n//details.ClearedAlarm = msg.alarm;\nreturn details*/\n\n/*\nvar details = {alarm: msg.alarm, count: 0};\n\nif (metadata.prevAlarmDetails) {\n    var prevDetails = JSON.parse(metadata.prevAlarmDetails);\n    if(prevDetails.count) {\n        details.count = prevDetails.count + 1;\n    }\n}\n\nreturn details;\n\n*/"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 193,
          "layoutY": 394
        },
        "type": "org.thingsboard.rule.engine.filter.TbCheckMessageNode",
        "name": "check filed",
        "debugMode": false,
        "configuration": {
          "messageNames": [
            "alarm_a",
            "alarm_b"
          ],
          "metadataNames": [],
          "checkAllKeys": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 730,
          "layoutY": 281
        },
        "type": "org.thingsboard.rule.engine.action.TbCreateAlarmNode",
        "name": "Create Alarm",
        "debugMode": false,
        "configuration": {
          "alarmType": "General Alarm A",
          "alarmDetailsBuildJs": "var details = {};\ndetails.alarm= msg.alarm_a;\n\nreturn details;\n\n\n/*\n\nvar details = {};\ndetails.alarm= msg.alarm;\nif (metadata.prevAlarmDetails) {\n    var prevDEtails = JSON.parse(metadata.prevAlarmDetails);\n   // details.count = prevDEtails.count + 1;\n}else\n{\n  //  details.count = 1;\n}\nreturn details;\n*/",
          "severity": "CRITICAL",
          "propagate": true,
          "useMessageAlarmData": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 487,
          "layoutY": 392
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Under Threshold",
        "debugMode": false,
        "configuration": {
          "jsScript": "return msg.alarm_a == 1;\n//return msg.temperature1 < -30 || msg.temperature1 > 50;"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1369,
          "layoutY": 158
        },
        "type": "org.thingsboard.rule.engine.mail.TbMsgToEmailNode",
        "name": "Notification - Email",
        "debugMode": false,
        "configuration": {
          "fromTemplate": "no-reply@iots.no",
          "toTemplate": "${CustomerEmail1}",
          "ccTemplate": "${CustomerEmail2},${CustomerEmail3},${CustomerEmail4}",
          "bccTemplate": null,
          "subjectTemplate": "Alarm - ${ss_building_name} - ${ss_Navn}",
          "bodyTemplate": "Hi,\n\nAn ${severity} alarm trigged by ${ss_Navn}.\n\nDetails: \nDate: ${date}\nBuilding: ${ss_building_name}\nAddress: ${ss_address}\nDevice: ${deviceName}\n\nRegards,\nIOT Solutions - Building Automation"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 555,
          "layoutY": 70
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetCustomerAttributeNode",
        "name": "Get Customer email",
        "debugMode": false,
        "configuration": {
          "attrMapping": {
            "email1": "CustomerEmail1",
            "email2": "CustomerEmail2",
            "email3": "CustomerEmail3",
            "email4": "CustomerEmail4"
          },
          "telemetry": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1128,
          "layoutY": 64
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Get device address",
        "debugMode": false,
        "configuration": {
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [
            "address",
            "Navn",
            "building_name"
          ],
          "latestTsKeyNames": [],
          "tellFailureIfAbsent": true
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 4,
        "type": "Created"
      },
      {
        "fromIndex": 2,
        "toIndex": 0,
        "type": "True"
      },
      {
        "fromIndex": 2,
        "toIndex": 1,
        "type": "False"
      },
      {
        "fromIndex": 4,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 16,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 15,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 13,
        "type": "True"
      },
      {
        "fromIndex": 11,
        "toIndex": 2,
        "type": "True"
      },
      {
        "fromIndex": 12,
        "toIndex": 4,
        "type": "Created"
      },
      {
        "fromIndex": 13,
        "toIndex": 12,
        "type": "True"
      },
      {
        "fromIndex": 13,
        "toIndex": 10,
        "type": "False"
      },
      {
        "fromIndex": 14,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 15,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 5,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}